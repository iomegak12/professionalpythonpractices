import requests
import json
import threading

from crmsystem.config import GlobalConfiguration
from crmsystem.utilities import ErrorProvider, CustomerEncoder
from crmsystem.models import CustomerProfile
from crmsystem.constants import GlobalConstants

ERRORS = [
    {"errorKey": 1, "errorId": "CUSTSVC001",
        "errorMessage": "Invalid Customer Service Callback Specified!"},
    {"errorKey": 2, "errorId": "CUSTSVC002",
        "errorMessage": "Invalid Customer Service URL Specified!"},
]


class CustomerService(threading.Thread):
    def __init__(self, callback):
        threading.Thread.__init__(self)

        if callback is None:
            raise ErrorProvider.get_error(ERRORS, 1)

        self.callback = callback

        configuration = GlobalConfiguration.get_configuration()
        customerServiceUrl = configuration[GlobalConstants.CUSTOMER_SERVICE_URL]

        if customerServiceUrl is None:
            raise ErrorProvider.get_error(ERRORS, 2)

        self.customerServiceUrl = customerServiceUrl

    def run(self):
        response = requests.get(self.customerServiceUrl)
        responseText = response.text
        processedCustomerProfiles = json.loads(
            responseText, object_hook=CustomerEncoder.transform)

        self.callback(processedCustomerProfiles)
